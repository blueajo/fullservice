{% set classes = [
  'product',
  'node',
  'node--type-' ~ node.bundle()|clean_class,
] %}

{# Hide the title - it's used in caption instead #}
{% set title_prefix = null %}
{% set title_suffix = null %}

<div{{ attributes.addClass(classes).setAttribute('id', 'p' ~ node.id()) }}>
  {# VIDEO takes precedence #}
  {% if node.field_video|length %}
  
    {% set media = node.field_video.0.entity %}
    {% if media.field_media_video_file|length %}
      {% set video_file = media.field_media_video_file.0.entity %}
      {# Get thumbnail - field_thumbnail references image_file media #}
      {% set thumbnail_url = null %}
      {% if media.field_thumbnail|length %}
        {% set thumbnail_media = media.field_thumbnail.0.entity %}
        {% if thumbnail_media and thumbnail_media.field_media_image|length %}
          {% set thumbnail_file = thumbnail_media.field_media_image.0.entity %}
          {% if thumbnail_file %}
            {% set thumbnail_url = file_url(thumbnail_file.uri.value|image_style('thumbnail_blur')) %}
          {% endif %}
        {% endif %}
      {% endif %}    
      
      <div
        class="lazy-video-container"
        data-cursor-action="plus"
        {% if image_ratio %} style="aspect-ratio: {{ image_ratio }};" {% endif %}
      >
        {% if thumbnail_url %}
          <img 
            class="video-thumbnail" 
            src="{{ thumbnail_url }}" 
            {% if image_ratio %} style="aspect-ratio: {{ image_ratio }};" {% endif %}
          >
        {% endif %}
        
        <video loop muted playsinline preload="none">
          <source data-src="{{ file_url(video_file.uri.value) }}" type="video/mp4">
        </video>
      </div>
    {% endif %}
  
  {# FALLBACK: IMAGE #}
  {% elseif node.field_image|length %}
    {% set media = node.field_image.0.entity %}
    {% if media.field_media_image|length %}
      {% set image_file = media.field_media_image.0.entity %}
      {% set full_url = file_url(image_file.uri.value) %}
      {% set thumb_url = image_file.uri.value|image_style('thumbnail_blur') %}
        <img 
          class="lazy-image lazy-loading"
          src="{{ thumb_url }}"
          data-src="{{ full_url }}"
          alt="{{ media.field_media_image.0.alt|default(node.title.value) }}"
          data-cursor-action="plus"
          {% if image_ratio %} style="aspect-ratio: {{ image_ratio }};" {% endif %}
        >
    {% endif %}
  {% endif %}

  <p class="caption">
    {{- node.title.value -}},
    {% if node.field_medium.value %}
      <span class="category">{{ node.field_medium.value }},</span>
    {% endif %}
    {% if node.field_year.value %}
      {{ node.field_year.value }}
    {% endif %}
  </p>
  
</div>