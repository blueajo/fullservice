{% set classes = [
  'product',
  'node',
  'node--type-' ~ node.bundle()|clean_class,
] %}

{# Hide the title - it's used in caption instead #}
{% set title_prefix = null %}
{% set title_suffix = null %}

<div{{ attributes.addClass(classes).setAttribute('id', 'p' ~ node.id()) }}>
  {# VIDEO takes precedence #}
  {% if node.field_video|length %}
  
    {% set media = node.field_video.0.entity %}
    {% if media.field_media_video_file|length %}
      {% set video_file = media.field_media_video_file.0.entity %}
      {# Get thumbnail - field_thumbnail references image_file media #}
      {% set thumbnail_url = null %}
      {% if media.field_thumbnail|length %}
        {% set thumbnail_media = media.field_thumbnail.0.entity %}
        {% if thumbnail_media and thumbnail_media.field_media_image|length %}
          {% set thumbnail_file = thumbnail_media.field_media_image.0.entity %}
          {% if thumbnail_file %}
            {% set thumbnail_url = file_url(thumbnail_file.uri.value|image_style('thumbnail_blur')) %}
          {% endif %}
        {% endif %}
      {% endif %}    
      
      <div
        class="lazy-video-container"
        data-cursor-action="plus"
        {% if image_ratio %} style="aspect-ratio: {{ image_ratio }};" {% endif %}
      >
        {% if thumbnail_url %}
          <img 
            class="video-thumbnail" 
            src="{{ thumbnail_url }}" 
            {% if image_ratio %} style="aspect-ratio: {{ image_ratio }};" {% endif %}
          >
        {% endif %}
        
        <video loop muted playsinline preload="none">
          <source data-src="{{ file_url(video_file.uri.value) }}" type="video/mp4">
        </video>
      </div>
    {% endif %}
  
  {# FALLBACK: IMAGE #}
  {% elseif node.field_image|length %}
    {% set media = node.field_image.0.entity %}
    {% if media.field_media_image|length %}
      {% set image_file = media.field_media_image.0.entity %}
      {% set image_uri = image_file.uri.value %}
      {% set image_alt = media.field_media_image.0.alt|default(node.title.value) %}

      {# Placeholder thumbnail #}
      {% set thumb = image_uri|image_style('thumbnail_blur') %}

      {# Full responsive images #}
      {% set mobile = file_url(image_uri|image_style('mobile')) %}
      {% set desktop = file_url(image_uri|image_style('desktop')) %}
      {% set desktop_large = file_url(image_uri|image_style('desktop_large')) %}

      <img
        class="lazy-image lazy-loading"
        src="{{ thumb }}"
        data-src="{{ mobile }}"
        data-srcset="
          {{ mobile }} 600w,
          {{ desktop }} 1200w,
          {{ desktop_large }} 1980w
        "
        data-sizes="
          (min-width: 1600px) 1980px,
          (min-width: 1200px) 1200px,
          100vw
        "
        alt="{{ image_alt }}"
        data-cursor-action="plus"
        {% if image_ratio %} style="aspect-ratio: {{ image_ratio }};" {% endif %}
      >
    {% endif %}
  {% endif %}

  <p class="caption">
    {{- node.title.value -}},
    {% if node.field_medium.value %}
      <span class="category">{{ node.field_medium.value }},</span>
    {% endif %}
    {% if node.field_year.value %}
      {{ node.field_year.value }}
    {% endif %}
  </p>
  
</div>